<html>


<body>
<script>
let boards = [];
let x = null;

function getOffset( el ) {
	var _x = 0;
	var _y = 0;
	while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
	_x += el.offsetLeft - el.scrollLeft;
	_y += el.offsetTop - el.scrollTop;
	el = el.offsetParent;
	}
	return { top: _y, left: _x };
}
	
function xMouseMove(evt) {
	if(x == null) return;
	let xyz = getOffset(x);
	x.style.top = evt.offsetY + xyz.top - Math.round(x.offsetHeight / 2);
	x.style.left = evt.offsetX + xyz.left - Math.round(x.offsetWidth / 2);

	boards.forEach((b) => {
		var xy = getOffset(b.domElement);
		var xy2 = getOffset(x);
		
		b.mousex = Math.floor((evt.x + xy2.left - xy.left - x.offsetLeft - b.domElement.offsetLeft) * b.w / b.domElement.offsetWidth);
		b.mousey = Math.floor((evt.y + xy2.top - xy.top - x.offsetTop - b.domElement.offsetTop) * b.h / b.domElement.offsetHeight);

		if(b.mousex > b.w - 1) {
			b.mousex = -1;
		} 

		if(b.mousex >= 0 && b.mousey >= 0) {
			if(evt.target == b.domElement) {
				x.style.left = Math.round(b.domElement.offsetWidth * b.mousex / b.w - (xy2.left - xy.left - x.offsetLeft - b.domElement.offsetLeft));
				x.style.top = Math.round(b.domElement.offsetHeight * b.mousey / b.h - (xy2.top - xy.top - x.offsetTop - b.domElement.offsetTop));
			}
		}
		b.render();
	});
}

function xClick(evt) {
	boards.forEach((b) => {
		if(b.mousex >= 0 && b.mousey >= 0 && b.mousex < b.w && b.mousey < b.h) {
			let y = b.board[b.mousex + b.w * b.mousey];
			if(y != null) {
				var xy = getOffset(x);
				
				b.board[b.mousex + b.w * b.mousey] = null;
				document.body.appendChild(y);

				y.style.position = "absolute";
				y.style.zIndex = "10";	
				y.style.top = evt.offsetY + xy.top - Math.round(y.offsetHeight / 2);
				y.style.left = evt.offsetX + xy.left - Math.round(y.offsetWidth / 2);
				
				y.addEventListener("mousemove",xMouseMove);
				y.addEventListener("mousedown",xClick);
			}
			b.board[b.mousex + b.w * b.mousey] = x;
			document.body.removeChild(x);
			x = y;
		} 
		b.render();
		
	});
}

class Board {	
	domElementClick(evt) {
		x = this.board[this.mousex + this.w * this.mousey];
		x.src = x.src1;
		this.board[this.mousex + this.w * this.mousey] = null;
		this.render();
		document.body.appendChild(x);
		
		var cv = this.domElement;
		var xy = getOffset(cv);
		
		x.style.position = "absolute";
		x.style.zIndex = "10";	
		x.style.top = evt.offsetY + xy.top - Math.round(x.offsetHeight / 2);
		x.style.left = evt.offsetX + xy.left - Math.round(x.offsetWidth / 2);
		
		x.addEventListener("mousemove",xMouseMove);
		x.addEventListener("click",xClick);
	}
	
	constructor() {
		this.domDiv = document.createElement("div");
		this.domDiv.style.position = "relative";

		this.domElement = document.createElement("canvas");
		this.domElement.width = 1000;
		this.domElement.height = 1000;
		this.domElement.style.borderWidth = "10px";
		this.domElement.style.borderStyle = "outset";
		this.domElement.style.width = "95%";

		this.domButtonUpElement = document.createElement("button");
		this.domButtonUpElement.innerHTML = "Uncover";
		this.domButtonUpElement.style.position = "absolute";
		this.domButtonUpElement.style.left = 0;
		this.domButtonUpElement.style.zIndex = 10;
		
		this.domButtonBackElement = document.createElement("button");
		this.domButtonBackElement.innerHTML = "Hide";
		this.domButtonBackElement.style.position = "absolute";
		this.domButtonBackElement.style.right = 0;
		this.domButtonBackElement.style.zIndex = 10;

		this.domDiv.appendChild(this.domButtonUpElement);
		this.domDiv.appendChild(this.domButtonBackElement);
		this.domDiv.appendChild(this.domElement);
		
		this.domElement.addEventListener("mouseout",((evt) => {
			this.mousex = -1;
			this.mousey = -1;
			this.render();
		}).bind(this));
		
		this.domElement.addEventListener("click",this.domElementClick.bind(this));
		this.domElement.addEventListener("mousemove",xMouseMove);
		
		this.domElement.addEventListener("mousemove",((evt) => {
			var cv = this.domElement;
			var xy = getOffset(cv);
			
			this.mousex = Math.floor((evt.x - xy.left) * this.w / cv.offsetWidth);
			this.mousey = Math.floor((evt.y - xy.top) * this.h / cv.offsetHeight);

			if(this.mousex > this.w - 1) this.mousex = - 1;
			if(this.mousey > this.h - 1) this.mousey = - 1;
					
			if(!this.board[this.mousex + this.w * this.mousey]) { // || (this.board[this.mousex + this.w * this.mousey].color != this.board.color && !this.team())) {
				this.mousex = -1;
				this.mousey = -1;
			}
			
			this.render();
		}).bind(this));
		this.domElement.addEventListener("mousemove",xMouseMove);
		
		boards.push(this);
	}

	render() {
		var cv = this.domElement;
		var ctx = cv.getContext("2d");
		
		ctx.fillStyle = "black";
		ctx.fillRect(0,0,cv.width,cv.height);
		
		var c = 0;
		for(var i = 0;i < this.w;++i) {
			for(var j = 0;j < this.h;++j) {
				ctx.fillStyle = c ? "darkgray" : "lightgray";
				ctx.fillRect(i * cv.width / this.w,j * cv.height / this.h,cv.width / this.w,cv.height / this.h);
				c = 1 - c;
			}
			c = 1 - c;
		}
		
		for(var i = 0;i < this.w;++i) {
			for(var j = 0;j < this.h;++j) {
				if(this.board[i + this.w * j] != null) {
					ctx.drawImage(this.board[i + this.w * j],i * cv.width / this.w,j * cv.height / this.h,cv.width / this.w,cv.height / this.h);
				}
			}
		}

		if(this.mousex >= 0 && this.mousey >= 0) {
			ctx.strokeStyle = "green"
			ctx.lineWidth = 100 / this.w * cv.width / cv.offsetWidth;
			
			ctx.beginPath();
			ctx.rect(this.mousex * cv.width / this.w,this.mousey * cv.height / this.h,cv.width / this.w,cv.height / this.h);
			ctx.stroke();
		}
	}
}

class EmptyBoard extends Board { 
	constructor() {
		super();
		
		this.w = 20;
		this.h = 4;

		this.domElement.width = this.w * 100;
		this.domElement.height = this.h * 100;
		
		this.board = [];
		for(var i = 0;i < this.w * this.h;++i) this.board.push(null);
		
		this.render();
	}
}


class ChessBoard extends Board { 
	constructor() {
		super();
		
		this.w = this.h = 8;
	
		this.board = [];
		for(var i = 0;i < 64;++i) this.board.push(null);
		
		this.board[0] = this.loadPiece("rook","rdd129","black");
		this.board[1] = this.loadPiece("knight","ndd129","black");
		this.board[2] = this.loadPiece("bishop","bdd129","black");
		this.board[3] = this.loadPiece("queen","qdd129","black");
		this.board[4] = this.loadPiece("king","kdd129","black");
		this.board[5] = this.loadPiece("bishop","bdd129","black");
		this.board[6] = this.loadPiece("knight","ndd129","black");
		this.board[7] = this.loadPiece("rook","rdd129","black");
		
		for(var i = 0;i < 8;++i) this.board[8 + i] = this.loadPiece("pawn","pdd129","black");
		
		this.board[56] = this.loadPiece("rook","rld129","white");
		this.board[57] = this.loadPiece("knight","nld129","white");
		this.board[58] = this.loadPiece("bishop","bld129","white");
		this.board[59] = this.loadPiece("queen","qld129","white");
		this.board[60] = this.loadPiece("king","kld129","white");
		this.board[61] = this.loadPiece("bishop","bld129","white");
		this.board[62] = this.loadPiece("knight","nld129","white");
		this.board[63] = this.loadPiece("rook","rld129","white");
		
		for(var i = 0;i < 8;++i) this.board[48 + i] = this.loadPiece("pawn","pld129","white");
	}
	
	loadPiece(name,imgName,color) {
		var y = {};
		
		if(typeof document !== "undefined") y = document.createElement("img");
		y.src1 = "img/" + imgName + ".png";
		y.src2 = "img/back01.gif";
		y.src = y.src1;
		y.shape = name;
		y.color = color;
		y.onload = this.render.bind(this);
		
		return y;
	}
}

class DiceSet extends Board {
	constructor() {
		super();
		
		this.w = this.h = 4;
		this.board = [];
		
		for(let i = 1;i <= 16;++i) {
			let y = document.createElement("img");
			y.src1 = "img/Alea_" + Math.trunc(6 * Math.random() + 1) + ".png";
			y.src2 = "img/back01.gif";
			y.src = y.src1;
			y.index = i;
			y.onload = this.render.bind(this);
			this.board.push(y);
		}
	}
}

function shuffle(xs) {
	var ys = [];
	
	while(xs.length > 0) {
		var i = Math.round(Math.random() * (xs.length - 1));
		ys.push(xs[i]);
		xs.splice(i,1);
	}
	
	return ys;
}

class CardSet extends Board {
	constructor() {
		super();
		
		this.w = this.h = 8;
	
		let xs = ["c","d","h","s"];
		this.board = [];
		
		xs.forEach((c) => {
			for(let i = 1;i <= 13;++i) {
				let y = document.createElement("img");
				y.src1 = "img/" + (i <= 9 ? "0" : "") + i + c + ".gif";
				y.src2 = "img/back01.gif";
				y.src = y.src1;
				y.color = c;
				y.index = i;
				y.onload = this.render.bind(this);
				this.board.push(y);
			}
		});
		
		this.board = shuffle(this.board);
	}
}

let cb = new ChessBoard();
document.body.appendChild(cb.domDiv);
cb.domDiv.style.width = "25%";
cb.domDiv.style.float = "left";

let cs = new CardSet();
document.body.appendChild(cs.domDiv);
cs.domDiv.style.width = "25%";
cs.domDiv.style.float = "left";

let ds = new DiceSet();
document.body.appendChild(ds.domDiv);
ds.domDiv.style.width = "25%";
ds.domDiv.style.float = "left";

let eb = new EmptyBoard();
document.body.appendChild(eb.domDiv);
eb.domDiv.style.height = "30%";
eb.domDiv.style.float = "left";
</script>
</body>
</html>


